.PHONY: help deps migrate seed setup clean logs verify

help: ## Show this help
	@echo "ğŸ“‹ Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

deps: ## Install Go dependencies
	@echo "ğŸ“¦ Installing dependencies..."
	@docker compose exec backend go mod download
	@docker compose exec backend go mod tidy
	@echo "âœ… Dependencies installed"

migrate: ## Run database migrations
	@echo "ğŸ”„ Running migrations..."
	@docker compose exec backend psql "host=afs-postgres port=5432 user=afs_user password=${POSTGRES_PASSWORD:-afs_password} dbname=afs_dev sslmode=disable" -f /app/migrations/001_create_schema.sql
	@echo "âœ… Migrations completed"

seed: ## Seed database with test data
	@echo "ğŸŒ± Seeding database (10K orders)..."
	@docker compose exec backend go run /app/cmd/seed/main.go
	@echo "âœ… Database seeded"

setup: migrate seed ## Full database setup (migrate + seed)
	@echo "âœ… Database ready!"

clean: ## Clean all data from database
	@echo "ğŸ§¹ Cleaning database..."
	@docker compose exec backend psql "host=afs-postgres port=5432 user=afs_user password=${POSTGRES_PASSWORD:-afs_password} dbname=afs_dev sslmode=disable" -c "TRUNCATE users, orders, payments RESTART IDENTITY CASCADE"
	@echo "âœ… Database cleaned"

logs: ## Show backend logs
	@docker compose logs -f backend

verify: ## Verify database content
	@echo "ğŸ” Verifying database..."
	@docker compose exec backend psql "host=afs-postgres port=5432 user=afs_user password=${POSTGRES_PASSWORD:-afs_password} dbname=afs_dev sslmode=disable" -c "SELECT 'users' as table_name, COUNT(*) as count FROM users UNION ALL SELECT 'orders', COUNT(*) FROM orders UNION ALL SELECT 'payments', COUNT(*) FROM payments;"